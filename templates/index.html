<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utility Bill OCR Extractor</title> <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 800px; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
            padding: 40px;
            text-align: center;
            color: #6c757d;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        #drop-zone.drag-over {
            background-color: #e9ecef;
            border-color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="card p-4">
            <div class="card-body">
                <h1 class="card-title text-center mb-4">ðŸ“„ Utility Bill OCR Extractor</h1> <p class="text-center text-muted mb-4">Upload one or more documents. Multi-page PDFs are fully supported.</p>
                
                <form id="upload-form">
                    <div id="drop-zone">
                        <p>Drag files here</p>
                        <p class="mb-0 small">(PDF, JPG, PNG)</p>
                        <input type="file" id="file-input" name="file" accept=".pdf,.jpg,.jpeg,.png" required multiple hidden>
                    </div>

                    <div id="file-list-container" class="mt-3" style="display: none;">
                        <h6>Selected Files:</h6>
                        <ul id="file-list" class="list-group"></ul>
                    </div>

                    <div class="mb-3 mt-3">
                        <label for="entity-filter" class="form-label">Filter by Customer or Site ID (Optional)</label>
                        <input type="text" class="form-control" id="entity-filter" name="entity_filter" placeholder="e.g., CUST-9017 or SITE-ONLY-ABC">
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-2 mt-3" disabled>âœ¨ Extract Data</button>
                </form>
            </div>
        </div>

        <div id="spinner-container" class="mt-4 text-center"></div>
        <div id="error-container" class="mt-4"></div>
        <div id="results-container" class="mt-4" style="display: none;"></div>
    </div>
    
    <script>
        // All JavaScript from V2 can remain the same.
        // It correctly handles multiple files and displays JSON results.
        const form = document.getElementById('upload-form');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileListContainer = document.getElementById('file-list-container');
        const fileList = document.getElementById('file-list');
        const submitButton = form.querySelector('button[type="submit"]');
        
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFiles(files);
            }
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            fileList.innerHTML = ''; 
            if (files.length === 0) {
                fileListContainer.style.display = 'none';
                submitButton.disabled = true;
                return;
            }
            
            for (const file of files) {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = `${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                fileList.appendChild(li);
            }
            fileListContainer.style.display = 'block';
            submitButton.disabled = false;
        }

        const resultsContainer = document.getElementById('results-container');
        const spinnerContainer = document.getElementById('spinner-container');
        const errorContainer = document.getElementById('error-container');
        let extractedData = {};

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            resultsContainer.style.display = 'none';
            resultsContainer.innerHTML = '';
            errorContainer.innerHTML = '';
            spinnerContainer.innerHTML = `
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Processing... This may take a moment.</p>`;

            const formData = new FormData(form);

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'An unknown server error occurred.');
                
                extractedData = data;
                displayResults(data);
            } catch (error) {
                errorContainer.innerHTML = `<div class="alert alert-danger" role="alert"><strong>Error:</strong> ${error.message}</div>`;
            } finally {
                spinnerContainer.innerHTML = '';
            }
        });

        function displayResults(data) {
            let finalHtml = '';
            
            // V3 handles complex nested JSON, so we need a recursive renderer
            const createTableFromObject = (obj) => {
                let table = '<table class="table table-striped table-bordered mb-0">';
                for (const [key, value] of Object.entries(obj)) {
                    const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    table += `<tr><td class="w-25"><strong>${formattedKey}</strong></td><td>`;
                    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                        table += createTableFromObject(value);
                    } else if (Array.isArray(value)) {
                         table += value.map(item => 
                            (typeof item === 'object' && item !== null) ? 
                            `<div class="card mt-2 mb-2"><div class="card-body p-2">${createTableFromObject(item)}</div></div>` :
                            item
                        ).join('');
                    } else {
                        table += value || 'N/A';
                    }
                    table += `</td></tr>`;
                }
                table += '</table>';
                return table;
            };

            finalHtml = `<div class="card mt-3"><div class="card-header"><h5 class="mb-0">Extracted Details</h5></div><div class="card-body">${createTableFromObject(data)}</div></div>`;
            finalHtml += `<div class="card mt-3"><div class="card-body text-center"><button id="download-json" class="btn btn-secondary">Download JSON</button></div></div>`;
            
            resultsContainer.innerHTML = finalHtml;
            resultsContainer.style.display = 'block';
            document.getElementById('download-json').addEventListener('click', () => downloadJson(data));
        }

        function downloadJson(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadBlob(blob, 'extracted_data_v3.json');
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>