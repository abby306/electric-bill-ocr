<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill OCR Extractor V3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 800px; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
            padding: 40px;
            text-align: center;
            color: #6c757d;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        #drop-zone.drag-over {
            background-color: #e9ecef;
            border-color: #0d6efd;
        }
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-icon .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="card p-4">
            <div class="card-body">
                <h1 class="card-title text-center mb-4">ðŸ“„ Bill OCR Extractor V3</h1>
                <p class="text-center text-muted mb-4">Upload one or more documents. Multi-page PDFs are fully supported.</p>
                
                <form id="upload-form">
                    <div id="drop-zone">
                        <p>Drag files here</p>
                        <p class="mb-0 small">(PDF, JPG, PNG)</p>
                        <input type="file" id="file-input" name="file" accept=".pdf,.jpg,.jpeg,.png" required multiple hidden>
                    </div>

                    <div id="file-list-container" class="mt-3" style="display: none;">
                        <h6>Selected Files:</h6>
                        <ul id="file-list" class="list-group"></ul>
                    </div>

                    <div class="mb-3 mt-3">
                        <label for="entity-filter" class="form-label">Filter by Customer or Site ID (Optional)</label>
                        <input type="text" class="form-control" id="entity-filter" name="entity_filter" placeholder="e.g., CUST-9017 or SITE-ONLY-ABC">
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-2 mt-3" disabled>âœ¨ Extract Data</button>
                </form>
            </div>
        </div>

        <div id="spinner-container" class="mt-4 text-center"></div>
        <div id="error-container" class="mt-4"></div>
        <div id="results-container" class="mt-4" style="display: none;"></div>
    </div>
    
    <script>
        const form = document.getElementById('upload-form');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileListContainer = document.getElementById('file-list-container');
        const fileList = document.getElementById('file-list');
        const submitButton = form.querySelector('button[type="submit"]');
        
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFiles(files);
            }
        });
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        function getFileId(file) {
            // Create a consistent, safe ID for the file DOM element
            return `file-item-${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
        }

        function handleFiles(files) {
            fileList.innerHTML = ''; 
            if (files.length === 0) {
                fileListContainer.style.display = 'none';
                submitButton.disabled = true;
                return;
            }
            
            for (const file of files) {
                const li = document.createElement('li');
                li.className = 'list-group-item file-list-item';
                li.id = getFileId(file);

                const fileNameSpan = document.createElement('span');
                fileNameSpan.textContent = `${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                
                const statusIconSpan = document.createElement('span');
                statusIconSpan.className = 'status-icon';
                
                li.appendChild(fileNameSpan);
                li.appendChild(statusIconSpan);
                fileList.appendChild(li);
            }
            fileListContainer.style.display = 'block';
            submitButton.disabled = false;
        }

        function setFileStatus(fileId, status) {
            const listItem = document.getElementById(fileId);
            if (!listItem) return;
            const iconSpan = listItem.querySelector('.status-icon');
            if (!iconSpan) return;

            switch(status) {
                case 'processing':
                    iconSpan.innerHTML = `<div class="spinner-border text-primary" role="status"></div>`;
                    break;
                case 'success':
                    iconSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="green" class="bi bi-check-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>`;
                    break;
                case 'failure':
                    iconSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="red" class="bi bi-x-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>`;
                    break;
                default:
                    iconSpan.innerHTML = '';
            }
        }

        const resultsContainer = document.getElementById('results-container');
        const spinnerContainer = document.getElementById('spinner-container');
        const errorContainer = document.getElementById('error-container');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            resultsContainer.style.display = 'none';
            resultsContainer.innerHTML = '';
            errorContainer.innerHTML = '';
            spinnerContainer.innerHTML = '';

            const files = Array.from(fileInput.files);
            const entityFilter = document.getElementById('entity-filter').value;
            let allFilesSucceeded = true;

            // Step 1: Initialize a new processing session on the backend
            let sessionId;
            try {
                spinnerContainer.innerHTML = `<p class="mt-2">Initializing session...</p>`;
                const sessionResponse = await fetch('/start_session', { method: 'POST' });
                if (!sessionResponse.ok) throw new Error('Could not start a new session.');
                const sessionData = await sessionResponse.json();
                sessionId = sessionData.session_id;
            } catch (error) {
                errorContainer.innerHTML = `<div class="alert alert-danger" role="alert"><strong>Error:</strong> ${error.message}</div>`;
                return;
            }

            // Step 2: Process each file sequentially
            for (const file of files) {
                const fileId = getFileId(file);
                setFileStatus(fileId, 'processing');
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('session_id', sessionId);

                try {
                    const fileResponse = await fetch('/upload_and_process_file', { method: 'POST', body: formData });
                    if (!fileResponse.ok) {
                        const errorData = await fileResponse.json();
                        throw new Error(errorData.error || `Failed to process ${file.name}`);
                    }
                    setFileStatus(fileId, 'success');
                } catch (err) {
                    setFileStatus(fileId, 'failure');
                    errorContainer.innerHTML = `<div class="alert alert-danger" role="alert"><strong>Error:</strong> ${err.message}</div>`;
                    allFilesSucceeded = false;
                    break; // Stop processing further files on failure
                }
            }

            // Step 3: If all files were processed, aggregate the results
            if (allFilesSucceeded) {
                try {
                    spinnerContainer.innerHTML = `<p class="mt-2">Aggregating results...</p>`;
                    const aggregateResponse = await fetch('/aggregate_results', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: sessionId, entity_filter: entityFilter })
                    });
                    if (!aggregateResponse.ok) {
                         const errorData = await aggregateResponse.json();
                        throw new Error(errorData.error || 'Failed to aggregate results.');
                    }
                    const finalData = await aggregateResponse.json();
                    displayResults(finalData);
                } catch (error) {
                     errorContainer.innerHTML = `<div class="alert alert-danger" role="alert"><strong>Error:</strong> ${error.message}</div>`;
                }
            }
            
            spinnerContainer.innerHTML = ''; // Clear spinner at the end
        });

        function displayResults(data) {
            let finalHtml = '';
            
            const createTableFromObject = (obj) => {
                let table = '<table class="table table-striped table-bordered mb-0">';
                for (const [key, value] of Object.entries(obj)) {
                    const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    table += `<tr><td class="w-25"><strong>${formattedKey}</strong></td><td>`;
                    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                        table += createTableFromObject(value);
                    } else if (Array.isArray(value)) {
                         table += value.map(item => 
                            (typeof item === 'object' && item !== null) ? 
                            `<div class="card mt-2 mb-2"><div class="card-body p-2">${createTableFromObject(item)}</div></div>` :
                            item
                        ).join('');
                    } else {
                        table += value || 'N/A';
                    }
                    table += `</td></tr>`;
                }
                table += '</table>';
                return table;
            };

            finalHtml = `<div class="card mt-3"><div class="card-header"><h5 class="mb-0">Extracted Details</h5></div><div class="card-body">${createTableFromObject(data)}</div></div>`;
            finalHtml += `<div class="card mt-3"><div class="card-body text-center"><button id="download-json" class="btn btn-secondary">Download JSON</button></div></div>`;
            
            resultsContainer.innerHTML = finalHtml;
            resultsContainer.style.display = 'block';
            document.getElementById('download-json').addEventListener('click', () => downloadJson(data));
        }

        function downloadJson(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadBlob(blob, 'extracted_data_v3.json');
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
